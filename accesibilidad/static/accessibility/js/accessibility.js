let fontSizeFactor = 100;
let isHighContrast = false;
let filterStates = {
    'underline-links': false,
    'big-cursor': false,
    'extra-spacing': false,
    'high-contrast-mode': false,
    'color-blind-mode': false  
};
let isReading = false;
let guideEnabled = false;
let guideElement = null;

document.addEventListener('DOMContentLoaded', () => {
    loadSettings();
    initializeReadingGuide();
    applyAccessibilityChanges();
    setupEventListeners();
});


function loadSettings() {
    const savedFont = localStorage.getItem('mg-font');
    if (savedFont) fontSizeFactor = parseInt(savedFont);
    
    const savedContrast = localStorage.getItem('mg-contrast');
    if (savedContrast === 'true') {
        isHighContrast = true;
        filterStates['high-contrast-mode'] = true;
    }
    
    Object.keys(filterStates).forEach(filter => {
        const saved = localStorage.getItem('mg-' + filter);
        if (saved === 'true') filterStates[filter] = true;
    });
}

// Crear el elemento de la guía visualmente
function initializeReadingGuide() {
    guideElement = document.getElementById('reading-guide');
    if (!guideElement) {
        guideElement = document.createElement('div');
        guideElement.id = 'reading-guide';
        guideElement.style.cssText = `
            display: none;
            position: fixed;
            height: 12px;
            width: 100%;
            background: rgba(255, 235, 0, 0.7);
            z-index: 2147483647;
            pointer-events: none;
            top: 0;
            left: 0;
            will-change: transform;
            box-shadow: 0 0 12px rgba(255, 255, 0, 0.9);
            border-bottom: 2px solid #ffd600;
        `;
        document.body.appendChild(guideElement);
    }
}

function setupEventListeners() {
    window.addEventListener('mousemove', (e) => {
        if (guideEnabled && guideElement) {
            guideElement.style.setProperty('--mouse-x', e.clientX + 'px');
            guideElement.style.setProperty('--mouse-y', e.clientY + 'px');
            
            if (guideElement.style.display !== 'block') {
                guideElement.style.display = 'block';
            }
        }
    });

    // Cerrar panel al hacer clic fuera
    document.addEventListener('click', (e) => {
        const panel = document.getElementById('accPanel');
        const trigger = document.querySelector('.minegate-acc-trigger');
        if (panel && trigger && !panel.contains(e.target) && !trigger.contains(e.target)) {
            panel.style.display = 'none';
        }
    });
}

// --- FUNCIONES DE ACCIÓN ---

function toggleAccPanel() {
    const panel = document.getElementById('accPanel');
    if (panel) {
        panel.style.display = (panel.style.display === 'block') ? 'none' : 'block';
    }
}

function adjustFont(dir) {
    fontSizeFactor += (dir * 10);
    fontSizeFactor = Math.min(Math.max(fontSizeFactor, 70), 150);
    localStorage.setItem('mg-font', fontSizeFactor);
    applyAccessibilityChanges();
}

function handleContrast() {
    isHighContrast = !isHighContrast;
    filterStates['high-contrast-mode'] = isHighContrast;
    localStorage.setItem('mg-contrast', isHighContrast);
    applyAccessibilityChanges();
}

function toggleFeature(className) {
    filterStates[className] = !filterStates[className];
    localStorage.setItem('mg-' + className, filterStates[className]);
    applyAccessibilityChanges();
}

function handleColorBlind() {
    console.log('handleColorBlind() called');
    toggleFeature('color-blind-mode');  // ← USA EL NOMBRE CORRECTO
    console.log('color-blind-mode state:', filterStates['color-blind-mode']);
    console.log('body classes:', document.body.className);
}

function toggleReadingGuide() {
    guideEnabled = !guideEnabled;
    if (guideElement) {
        guideElement.style.display = guideEnabled ? 'block' : 'none';
    }
}

function applyAccessibilityChanges() {
    // Cambia el tamaño de fuente en la raíz (HTML)
    document.documentElement.style.fontSize = fontSizeFactor + "%";
    
    // Aplica las clases de filtros al BODY
    const body = document.body;
    body.classList.toggle('underline-links', filterStates['underline-links']);
    body.classList.toggle('big-cursor', filterStates['big-cursor']);
    body.classList.toggle('extra-spacing', filterStates['extra-spacing']);
    body.classList.toggle('high-contrast-mode', filterStates['high-contrast-mode']);
    body.classList.toggle('color-blind-mode', filterStates['color-blind-mode']); // ← IMPORTANTE

    // Actualizar visualmente los botones del panel (el check de ✓)
    document.querySelectorAll('.floral-btn').forEach(btn => {
        const onclick = btn.getAttribute('onclick');
        
        // Para botones que usan toggleFeature
        const featureMatch = onclick?.match(/toggleFeature\('([^']+)'\)/);
        if (featureMatch && filterStates[featureMatch[1]]) {
            btn.classList.add('active');
        } else if (featureMatch) {
            btn.classList.remove('active');
        }
        
        // Para el botón de daltonismo que usa handleColorBlind
        if (onclick?.includes('handleColorBlind') && filterStates['color-blind-mode']) {
            btn.classList.add('active');
        } else if (onclick?.includes('handleColorBlind')) {
            btn.classList.remove('active');
        }
        
        // Para el botón de contraste
        if (onclick?.includes('handleContrast') && filterStates['high-contrast-mode']) {
            btn.classList.add('active');
        } else if (onclick?.includes('handleContrast')) {
            btn.classList.remove('active');
        }
    });
}

function handleTextToSpeech() {
    if (!isReading) {
        const text = window.getSelection().toString() || document.body.innerText;
        if (!text.trim()) return;

        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = 'es-ES';
        msg.onend = () => isReading = false;
        msg.onerror = () => isReading = false;
        window.speechSynthesis.speak(msg);
        isReading = true;
    } else {
        window.speechSynthesis.cancel();
        isReading = false;
    }
}

function resetAll() {
    fontSizeFactor = 100;
    isHighContrast = false;
    filterStates = {
        'underline-links': false,
        'big-cursor': false,
        'extra-spacing': false,
        'high-contrast-mode': false,
        'color-blind-mode': false  // ← INCLUIDO EN RESET
    };
    
    // Limpiar storage
    localStorage.clear();
    
    // Desactivar guía
    guideEnabled = false;
    if (guideElement) guideElement.style.display = 'none';
    
    // Detener voz
    window.speechSynthesis.cancel();
    isReading = false;
    
    applyAccessibilityChanges();
    
    // Cerrar panel
    const panel = document.getElementById('accPanel');
    if (panel) panel.style.display = 'none';
}